<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê—É–¥–∏—Ç –¥–æ—Å–∫–∏ —Ü–µ—Ö–∞</title>
  <style>
    :root {
      --bg: #faf9f7;
      --ink: #1f2328;
      --muted: #6b7280;
      --brand: #0ea5e9;
      --brand-ink: #0b5da6;
      --card: #ffffff;
      --ring: rgba(14,165,233,0.35);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f14;
        --ink: #eef2f7;
        --muted: #9aa6b2;
        --brand: #38bdf8;
        --brand-ink: #7dd3fc;
        --card: #0f1520;
        --ring: rgba(56,189,248,0.3);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    header { display: grid; gap: 8px; padding: 16px; background: var(--card); border-radius: 18px; box-shadow: 0 1px 0 rgba(0,0,0,.06), 0 12px 32px rgba(0,0,0,.06); }
    .title { display:flex; align-items: center; gap: 10px; font-weight: 700; font-size: 22px; }
    .badge { font: 600 12px/1.2 system-ui; color: var(--brand-ink); background: rgba(14,165,233,.12); padding: 6px 10px; border-radius: 999px; }
    .muted { color: var(--muted); font-size: 14px; }

    .tabs { margin-top: 14px; display:flex; gap: 8px; flex-wrap: wrap; }
    .tab-btn {
      appearance: none; border: 1px solid rgba(0,0,0,.06); background: var(--card); color: var(--ink);
      padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .tab-btn[aria-selected="true"], .tab-btn:focus-visible {
      outline: none; border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring);
    }
    .grid { display: grid; gap: 14px; margin-top: 16px; }
    .card { background: var(--card); border-radius: 18px; padding: 0; overflow: hidden; box-shadow: 0 1px 0 rgba(0,0,0,.06), 0 12px 32px rgba(0,0,0,.06); }

    .toolbar { display:flex; gap: 10px; align-items:center; padding: 10px; border-bottom: 1px solid rgba(0,0,0,.07); }
    .toolbar .right { margin-left:auto; display:flex; gap:8px; }
    .btn { appearance: none; border: none; padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn.primary { background: var(--brand); color: white; }
    .btn.ghost { background: transparent; border: 1px solid rgba(0,0,0,.08); color: var(--ink); }
    .btn:active { transform: translateY(1px); }

    iframe { width: 100%; height: 72vh; border: none; display: block; background: #fff; }
    .hint { padding: 16px; }
    .hint code { background: rgba(0,0,0,.06); padding: 2px 6px; border-radius: 6px; }

    footer { color: var(--muted); font-size: 12px; text-align:center; padding: 18px 0 32px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">üß≠ –ê—É–¥–∏—Ç –¥–æ—Å–∫–∏ —Ü–µ—Ö–∞ <span id="shopBadge" class="badge" hidden></span></div>
      <div class="muted">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ ‚Üí –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É ‚Üí —Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫.
        <span id="who"></span>
      </div>
      <div class="tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <button class="tab-btn" id="tab-audit" role="tab" aria-selected="true" aria-controls="panel-audit">üìù –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç</button>
        <button class="tab-btn" id="tab-history" role="tab" aria-selected="false" aria-controls="panel-history">üìä –ò—Å—Ç–æ—Ä–∏—è –∞—É–¥–∏—Ç–æ–≤</button>
      </div>
    </header>

    <section class="grid">
      <!-- AUDIT CARD -->
      <div id="panel-audit" class="card" role="tabpanel" aria-labelledby="tab-audit">
        <div class="toolbar">
          <strong>–§–æ—Ä–º–∞ –∞—É–¥–∏—Ç–∞</strong>
          <div class="right">
            <button class="btn ghost" id="openForm">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üó</button>
            <button class="btn primary" id="copyLink">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          </div>
        </div>
        <div id="auditWrap">
          <iframe id="auditFrame" title="–§–æ—Ä–º–∞ –∞—É–¥–∏—Ç–∞ (–Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º—ã)"></iframe>
          <div id="auditHint" class="hint" hidden>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å—Å—ã–ª–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä:<br>
              <code>?form=https%3A%2F%2Fforms.yandex.ru%2Fu%2FXXXX%2F&history=https%3A%2F%2Fdatalens.yandex%2FYYYY&_autoupdate=60&shop=–¶–µ—Ö+5</code>
            </p>
          </div>
        </div>
      </div>

      <!-- HISTORY CARD -->
      <div id="panel-history" class="card" role="tabpanel" aria-labelledby="tab-history" hidden>
        <div class="toolbar">
          <strong>–ò—Å—Ç–æ—Ä–∏—è –∞—É–¥–∏—Ç–æ–≤</strong>
          <div class="right">
            <button class="btn ghost" id="openHistory">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üó</button>
          </div>
        </div>
        <div id="historyWrap">
          <iframe id="historyFrame" title="–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ (DataLens/–¢–∞–±–ª–∏—Ü—ã)"></iframe>
          <div id="historyHint" class="hint" hidden>
            <p>–ó–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä <code>history</code> ‚Äî –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ DataLens (–∏–ª–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É), –Ω–∞–ø—Ä–∏–º–µ—Ä:<br>
              <code>history=https%3A%2F%2Fdatalens.yandex%2Fabcd1234%3F_embedded%3D1%26_no_controls%3D1</code></p>
          </div>
        </div>
      </div>
    </section>

    <footer>–í–µ—Ä—Å–∏—è: 1.0 ‚Ä¢ –≠—Ç–æ—Ç —ç–∫—Ä–∞–Ω –º–æ–∂–Ω–æ —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∏–ª–∏ –∑–∞–∫—Ä–µ–ø–∏—Ç—å QR-–∫–æ–¥–æ–º –Ω–∞ –¥–æ—Å–∫–µ</footer>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const formUrl = qs.get('form');          // –ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º—É
    const historyUrl = qs.get('history');    // –ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ DataLens/—Ç–∞–±–ª–∏—Ü—É
    const shop = qs.get('shop');             // –∏–º—è —Ü–µ—Ö–∞ (–±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ —Ñ–æ—Ä–º—É)
    const formHiddenParam = qs.get('form_field') || 'shop'; // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –≤ —Ñ–æ—Ä–º–µ
    const autoupdate = qs.get('_autoupdate') || '60';       // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DataLens (—Å–µ–∫)

    // Header badges
    const badge = document.getElementById('shopBadge');
    if (shop) { badge.textContent = shop; badge.hidden = false; }

    // Tabs logic
    const tabAudit = document.getElementById('tab-audit');
    const tabHistory = document.getElementById('tab-history');
    const panelAudit = document.getElementById('panel-audit');
    const panelHistory = document.getElementById('panel-history');
    function selectTab(which) {
      const auditSelected = which === 'audit';
      tabAudit.setAttribute('aria-selected', auditSelected);
      tabHistory.setAttribute('aria-selected', !auditSelected);
      panelAudit.hidden = !auditSelected;
      panelHistory.hidden = auditSelected;
    }
    tabAudit.addEventListener('click', () => selectTab('audit'));
    tabHistory.addEventListener('click', () => selectTab('history'));

    // Build safe URLs
    function appendParam(url, key, value) {
      if (!url || !key || value==null) return url;
      const u = new URL(url);
      u.searchParams.append(key, value);
      return u.toString();
    }
    function ensureDatalensParams(url) {
      if (!url) return url;
      const u = new URL(url);
      if (!u.searchParams.has('_embedded')) u.searchParams.set('_embedded','1');
      if (!u.searchParams.has('_no_controls')) u.searchParams.set('_no_controls','1');
      if (!u.searchParams.has('_autoupdate') && autoupdate) u.searchParams.set('_autoupdate', autoupdate);
      return u.toString();
    }

    // Init iframes
    const auditFrame = document.getElementById('auditFrame');
    const auditHint = document.getElementById('auditHint');
    const openFormBtn = document.getElementById('openForm');
    const copyLinkBtn = document.getElementById('copyLink');

    if (formUrl) {
      const src = shop ? appendParam(formUrl, formHiddenParam, shop) : formUrl;
      auditFrame.src = src;
      openFormBtn.onclick = () => window.open(src, '_blank');
      copyLinkBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(src); copyLinkBtn.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'; setTimeout(()=>copyLinkBtn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',1500);} catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'); }
      };
    } else {
      auditFrame.style.display='none';
      auditHint.hidden = false;
      openFormBtn.disabled = true; copyLinkBtn.disabled = true;
    }

    const historyFrame = document.getElementById('historyFrame');
    const historyHint = document.getElementById('historyHint');
    const openHistoryBtn = document.getElementById('openHistory');
    if (historyUrl) {
      const src = ensureDatalensParams(historyUrl);
      historyFrame.src = src;
      openHistoryBtn.onclick = () => window.open(src, '_blank');
    } else {
      historyFrame.style.display='none';
      historyHint.hidden = false;
      openHistoryBtn.disabled = true;
    }

    // Deep link to tab via #hash
    if (location.hash === '#history') selectTab('history');
  </script>
</body>
</html>
